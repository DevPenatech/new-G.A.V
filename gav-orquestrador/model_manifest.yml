# O Manifesto do Modelo define o comportamento do G.A.V. de forma declarativa.
# O Orquestrador irá carregar este ficheiro para saber como agir.

versao_manifesto: 1.0

# Regras de roteamento são executadas em ordem. A primeira que corresponder é executada.
roteamento:
  # Regra 1: Bypass para ver o carrinho. É uma ação determinística.
  - nome: "Verificar Carrinho (Bypass)"
    bypass_llm: true
    condicoes:
      - tipo: regex
        padrao: '\b(carrinh[oa]s?|ver carrinho|meu carrinho|mostrar carrinho|exibir carrinho)\b'
    acao:
      tool_name: "ver_carrinho"

  # Regra 2: Bypass para escolha de item. Ação baseada no estado da conversa.
  - nome: "Extrair Escolha de Item (Memória)"
    bypass_llm: true
    condicoes:
      - tipo: estado_sessao
        estado: "aguardando_escolha_item"
    acao:
      # 'handler' indica uma função específica no código, não uma ferramenta.
      handler: "extrair_escolha_do_contexto"

  # Regra 3: Rota Padrão com IA (Master Prompt)
  - nome: "Análise de Intenção e Extração de Parâmetros com IA"
    bypass_llm: false
    acao:
      tipo: "triagem_llm"
      prompt: "prompt_triagem_intencao"
      mapeamento_intencao:
        - intencao: "busca_produto"
          acao:
            passos:
              - tipo: "extracao_parametros_llm"
                prompt: "prompt_mestre"
                # Saída esperada: {"tool_name":"buscar_produtos","parameters":{"query":"...","ordenar_por":"..."}}
              - tipo: "executar_ferramenta"
                ferramenta: "buscar_produtos"
                # O orquestrador deve usar os "parameters" retornados no passo anterior.
              - tipo: "geracao_llm"
                prompt: "prompt_gerar_resposta_busca"   # <<< AQUI está o gerador que faltava
                # Entrada recomendada ao LLM: um resumo compacto dos top itens com codprod, UN/CX e preços.
        # (opcional) roteamentos adicionais:
        - intencao: "escolha_de_item"
          acao:
            handler: "extrair_escolha_do_contexto"
        - intencao: "saudacao"
          acao:
            handler: "saudacao_padrao"
        - intencao: "conversa_fiada"
          acao:
            handler: "handle_chitchat"